<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>J2H - JSON &lt;-&gt; HTML</title>
<script type="text/javascript" charset="UTF-8" src="j2h.js"></script>
<style type="text/css">
* {
    margin: 0;
    padding: 0;
    font-size: 100%;
    box-sizing: border-box;
}
html,body {
    height: 100%;
    font-family: 'Helvetica Neue';
}
li {
    list-style-position: inside;
}

header {
    position: absolute;
    height: 3em;
    width: 100%;
    overflow: hidden;
    color: #555;
    background-color: #000;
    border-bottom: 1px #fff solid;
    box-shadow: 0 0 3px #ddd;
}
header > * {
    display: inline-block;
    height: 100%;
}
header > h1 {
    position: absolute;
    padding-left: 10px;
    color: #fff;
    font-size: 180%;
    line-height: 150%;
}
header > p {
    margin-left: 5.6em;
    padding-left: 1ex;
    width: 100%;
    background-color: #fcfcfc;
}
header > *:before {
    display: inline-block;
    content: '.';
    visibility: hidden;
    height: 100%;
    vertical-align: middle;
}

.main {
    height: 100%;
    padding-top: 3em;
}

#html {
    height: 70%;
    padding: 1em;
    overflow: auto;
    border-top: 1px #f6f6f6 solid;
}
#html ul {
    padding-left: 1.4em;
}
#html li {
    border: 1px transparent solid;
}
#html li span {
    display: inline-block;
}

#json {
    height: 30%;
    overflow: hidden;
    background-color: #fff;
    border-top: 1px #ccc solid;
}
#json > ul {
    position: absolute;
    height: 2em;
    width: 100%;
    padding: 0 1em;
    cursor: row-resize;
    text-align: right;
    background-color: #eee;
    border-bottom: 1px #ccc solid;
}
#json > ul li {
    display: inline-block;
    height: 100%;
}
#json > ul li:before {
    display: inline-block;
    content: '.';
    visibility: hidden;
    height: 100%;
    vertical-align: middle;
}
#json > p {
    height: 100%;
    padding-top: 2em;
    color: #fff;
    border: none;
}
#json > p > textarea {
    height: 100%;
    width: 100%;
    padding: 1em;
    outline-width: thick;
    background-color: transparent;
    border: none;
}
</style>
</head>
<body>
<header>
<h1>J2H</h1>
<p>JSON&lt;-&gt;HTML Editor</p>
</header>
<div class="main">
<!-- editor -->
<article id="html"></article>

<!-- raw text -->
<aside id="json">
<!-- toolbar -->
<ul>
<li><a href="#" name="apply">apply</a></li>
</ul>
<p><textarea></textarea></p>
</aside>

</div>
<!-- controller -->
<script type="text/javascript" charset="UTF-8">

/* mouse tracker */
var TRACK_START = 1 << 0,
    TRACK_PROGRESS = 1 << 1,
    TRACK_END = 1 << 2;

function evtCancel( evt ){
    evt.preventDefault();
    evt.cancelBubble = true;
    evt.returnValue = false;
}

function setMouseTracker( handle, callback )
{
    var origin = {},
        ctx = {},
        setOrigin = function( evt ){
            origin.x = evt.x;
            origin.y = evt.y;
        },
        sendDiff = function( evt, type )
        {
            if( !callback( evt.x - origin.x, evt.y - origin.y, type, ctx ) || 
                type === TRACK_END ){
                onFinish();
            }
        },
        onFinish = function(){
            window.removeEventListener( 'mouseup', onEnd );
            window.removeEventListener( 'mousemove', onTrack );
        },
        onTrack = function( evt ){
            sendDiff( evt, TRACK_PROGRESS );
            return false;
        },
        onEnd = function( evt ){
            sendDiff( evt, TRACK_END );
            return false;
        },
        onStart = function( evt )
        {
            evtCancel( evt );
            setOrigin( evt );
            ctx = {};
            if( callback( origin.x, origin.y, TRACK_START, ctx ) ){
                window.addEventListener( 'mouseup', onEnd );
                window.addEventListener( 'mousemove', onTrack );
            }
            return false;
        };
    
    handle.addEventListener( 'mousedown', onStart );
    
    return {
        clearMouseTracker: function(){
            onFinish();
            handle.removeEventListener( 'mousedown', onStart );
        }
    };
}

/* interface elements */
var J2H = new j2h(),
    JSON_PANE = {
        pane: document.querySelector('#json'),
        toolbar: document.querySelector('#json ul'),
        textarea: document.querySelector('#json textarea')
    },
    HTML_PANE = {
        pane: document.querySelector('#html'),
    },
    WIDTH = 0,
    CONTENT_HEIGHT = 0,
    MAX_HEIGHT = 0,
    MIN_HEIGHT = 0,
    PER_HEIGHT = 0,
    // horizontal-tab
    HT_CODE = 0x9,
    HT_LEN = 4;

function json2elm()
{
    var tree;
    
    this.begin = function(){
        tree = [];
    };
    this.end = function(){
        HTML_PANE.pane.innerText = '';
        HTML_PANE.pane.appendChild( tree[0] );
        tree = undefined;
    };
    this.openTree = function( lv, type, key )
    {
        if( !lv ){
            tree[lv] = document.createElement('ul');
        }
        else
        {
            var parent = lv && tree[lv-1] || undefined,
                wrapper = document.createElement('li'),
                keyNode = document.createElement('span'),
                valNode = document.createElement('ul');
            
            wrapper.setAttribute( 'data-type', type );
            wrapper.appendChild( keyNode );
            wrapper.appendChild( valNode );
            
            keyNode.setAttribute( 'data-field', 'key' );
            keyNode.innerText = key;
            valNode.setAttribute( 'data-field', 'val' );
            tree[lv] = valNode;
            
            parent.appendChild( wrapper );
        }
    };
    this.closeTree = function( lv, type, key )
    {
        if( lv !== 0 ){
            tree[lv] = null;
        }
    };
    this.createLeaf = function( lv, type, key, val )
    {
        var parent = lv && tree[lv-1] || undefined, 
            keyNode = document.createElement('span'),
            valNode = document.createElement('span'),
            wrapper = document.createElement('li');
        
        wrapper.setAttribute( 'data-type', type );
        wrapper.appendChild( keyNode );
        wrapper.appendChild( valNode );
        
        keyNode.setAttribute( 'data-field', 'key' );
        keyNode.innerText = key;
        valNode.setAttribute( 'data-field', 'val' );
        valNode.innerText = val;
        
        parent.appendChild( wrapper );
    };
}

function trackResizeWindow()
{
    WIDTH = HTML_PANE.pane.clientWidth;
    CONTENT_HEIGHT = HTML_PANE.pane.clientHeight + JSON_PANE.pane.clientHeight;
    MAX_HEIGHT = CONTENT_HEIGHT - JSON_PANE.toolbar.clientHeight * 2;
    MIN_HEIGHT = JSON_PANE.toolbar.clientHeight * 2;
    PER_HEIGHT = CONTENT_HEIGHT / 100;
}

function trackResizeView( x, y, type, ctx )
{
    var htmlp = HTML_PANE.pane,
        jsonp = JSON_PANE.pane;
    
    if( type === TRACK_START ){
        ctx.height = HTML_PANE.pane.clientHeight;
    }
    else if( type === TRACK_PROGRESS && y )
    {
        var modify = ctx.height + y;
        if( modify > MIN_HEIGHT && modify < MAX_HEIGHT ){
            htmlp.style.height = modify + 'px';
            jsonp.style.height = CONTENT_HEIGHT - modify + 'px';
        }
    }
    else if( type === TRACK_END ){
        htmlp.style.height = HTML_PANE.pane.clientHeight / PER_HEIGHT + '%';
        jsonp.style.height = JSON_PANE.pane.clientHeight / PER_HEIGHT + '%';
    }
    
    return true;
}

function onLoadRawJSON( evt )
{
    var err;
    
    evtCancel( evt );
    err = J2H.loadJSON( JSON_PANE.textarea.value );
    if( err ){
        alert( err.stack );
    }
    else {
        JSON_PANE.textarea.value = J2H.toJSON( HT_LEN );
        J2H.traverse();
    }
    return false;
}

function initTextarea()
{
    var textarea = JSON_PANE.textarea,
        tabHook = function( evt )
        {
            if( evt.keyCode === HT_CODE )
            {
                var txt = textarea.value,
                    start = textarea.selectionStart,
                    end = textarea.selectionEnd,
                    cursor = start + HT_LEN;
                
                evtCancel( evt );
                txt = [
                    txt.slice( 0, start ), 
                    (new Array(HT_LEN+1)).join(' '), 
                    txt.slice( end )
                ].join('');
                textarea.value = txt;
                // set caret
                textarea.selectionStart = cursor;
                textarea.selectionEnd = cursor;
            }
            
            return false;
        };
    
    textarea.addEventListener( 'keydown', tabHook );
}

// init interface components
function initUI()
{
    initTextarea();
    // call for initialize
    trackResizeWindow();
    // track window resize event
    window.addEventListener('resize', trackResizeWindow );
    // track mouse move event on JSON_PANE.toolbar element
    setMouseTracker( JSON_PANE.toolbar, trackResizeView );
    
    // set click event
    JSON_PANE.toolbar.querySelector('a[name="apply"]')
    .addEventListener( 'click', onLoadRawJSON );
    // set delegator
    J2H.delegator = new json2elm();
}

initUI();

</script>
</body>
</html>

